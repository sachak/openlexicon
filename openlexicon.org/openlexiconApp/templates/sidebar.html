<!-- TODO : hide sidebar on small screens (phone) ? Use classes : navbar-collapse collapse d-none -->
<form id="filter_form" method="POST">
    {% csrf_token %}
    <div id="sidebar_filter" class="col p-0 text-white w-sidebar d-md-flex sidebar">
        <!-- fixed sidebar -->
        <div class="navbar-light w-sidebar">
            {% for database, column_list in all_columns.items %}
            <div> <!-- if we want only one dropdown open at any given time, add class "nav-menu" -->
                <div class="nav-menu-text list-group-item list-group-item-action" id="submenu_{{database.id}}_head" onclick="menu_click(event)">
                    <input type="checkbox" id="checkbox_db_{{database.id}}" name="{{database.id}}" class="database-checkbox" onclick="check_all(this)"/>
                    <span class="sidebar-span">{{database}}</span>
                    <span class="submenu-icon ml-auto"> <i class="fas"></i> </span>
                </div>
                <!-- Submenu area -->
                <div id='submenu_{{database.id}}' class="collapse submenu-collapse">
                    {% for column in column_list %}
                    <div id='div_check_{{column.id}}' class="list-group-item list-group-item-action navbar-item-text">
                        <input type="checkbox" id="checkbox_col_{{column.id}}" name="{{database.id}}" onclick="check_instance(this);"/>
                        <label for="checkbox_col_{{column.id}}" style="margin-bottom:0">{{column}}</label>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</form>

<script>
    function reveal_menu(object){
        let menu = $(object).parents('.nav-menu-text'); // database checkbox
        if (menu.prop("id") == undefined) { // column checkbox
            menu = $(object).parents('.submenu-collapse').prev();
        }
        // If check all, open menu if not already the case
        if ($(object).prop('checked') && !menu_is_open(menu)) {
            open_menu(menu);
        }
    }

    $('.nav-menu-text').each(function(){
        // var state = localStorage.getItem($(this).prop('id'));
        // if(state === 'expanded'){
        if (false) {
            expand_menu(this);
        } else {
            collapse_menu(this);
        }
    });

    function filter_callback() {
        if (checkbox_ready) { // makes sure we do not trigger the ajax call if checkboxing results from initial selection of checkbox (on GET)
            col_string = [];
            column_dict = {};
            database_order = [];
            {% for database, column_list in all_columns.items %}
                {% for column in column_list %}
                    if ($("#checkbox_col_{{column.id}}").prop("checked")) {
                        col_string.push("{{database.id}}__{{column.id}}");
                        json_key = {{database.id}};
                        if (!column_dict.hasOwnProperty(json_key)) {
                            column_dict[json_key] = [];
                            database_order.push(json_key);
                        }
                        column_dict[json_key].push({id: {{column.id}}, code: "{{column.code}}", size: "{{column.size}}", type: "{{column.type}}"});
                    }
                {% endfor %}
            {% endfor %}
            col_string = col_string.join(",");
            set_table();
        }
    }

    function check_all(object) {
        $('input[name='+$(object).attr("name")+']').each(function(){
            $(this).prop('checked', $(object).prop('checked'));
        });
        reveal_menu($(object));
        filter_callback();
    }

    function check_instance(object){
        let database = $(object).attr("name");
        let nb_checked = $('#submenu_'+database+' :input[name='+database+']:checked').length;
        $("#checkbox_db_"+database).prop("indeterminate", false);
        if (nb_checked == $('#submenu_'+database+' :input[name='+database+']').length) {
            $("#checkbox_db_"+database).prop("checked", true);
            reveal_menu($(object));
        }else if (nb_checked == 0) {
            $("#checkbox_db_"+database).prop("checked", false);
        }else{
            $("#checkbox_db_"+database).prop("indeterminate", true);
            reveal_menu($(object));
        }
        filter_callback();
    }
</script>
